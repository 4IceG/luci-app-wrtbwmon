<%#
 Licensed to the public under the Apache License 2.0.
-%>

<%
	local fs = require "nixio.fs"
	local stat = require "luci.tools.status"
	local cursor = luci.model.uci.cursor()
	local rv = {
		db = cursor:get("wrtbwmon", "general", "path"),
		data = {},
	}

--	Function to update the mac-hostname table.
	function getmactable()
		local mactable = {}
		local leases = stat.dhcp_leases()

		if fs.access("/etc/wrtbwmon.user") then
			for line in io.lines("/etc/wrtbwmon.user") do
				local macpair={}
				setmetatable(macpair, {__index = table.insert})
				line:gsub("[^,]+", macpair)
				macpair.__index = nil
				mactable[macpair[1]:lower()] = macpair[2]
			end
		end

		for _, line in ipairs(leases) do
			if not mactable[line.macaddr:lower()] then
				mactable[line.macaddr:lower()] = line.hostname
			end
		end

		return mactable
	end

--	Rename the db file for ipv6.
	function fileRename(fileName, tag)
		local idx = fileName:match(".+()%.%w+$")
		if(idx) then
			return fileName:sub(1, idx-1) .. tag .. fileName:sub(idx, -1)
		else
			return fileName .. tag
		end
	end

	if luci.http.formvalue("proto") ~= nil then
		local cmd_setup = "/etc/init.d/wrtbwmon restart"
		local cmd_update = nil
		local db = nil
		local mactable = getmactable()

--		Update the database.
		if  luci.http.formvalue("proto") == "ipv4" then
			cmd_update = "wrtbwmon -4 -f " .. rv.db .. " >>/dev/null 2>&1"
			db = rv.db
		elseif  luci.http.formvalue("proto") == "ipv6" then
			cmd_update = "wrtbwmon -6 -f " .. rv.db .. " >>/dev/null 2>&1"
			db = fileRename(rv.db, ".6")
		end
		os.execute(cmd_update)

--		Process the database.
		for line in io.lines(db) do
			local usageeach={}
			setmetatable(usageeach, {__index = table.insert})
			line:gsub("[^,]+", usageeach)
			usageeach.__index = nil
			usageeach[1]=usageeach[1]:lower()

			if mactable[usageeach[1]] then
				usageeach[3] = mactable[usageeach[1]]
			else
				usageeach[3] = usageeach[1]
			end

			(rv.data)[#(rv.data)+1] = usageeach
		end

--		Setup the background update process.
		if not nixio.fs.access("/var/run/wrtbwmon.pid") then
			io.popen(cmd_setup)
		end

--		Transfer the database to js.
		luci.http.prepare_content("application/json")
		luci.http.write_json(rv.data)
		return
	end

	if luci.http.formvalue("UpdateLable") == "1" then
		luci.http.status(200, "OK")
		return
	end

	if  luci.http.formvalue("reset") == "1" then
		luci.sys.call("ip -4 neigh flush dev br-lan && ip -6 neigh flush dev br-lan")
		luci.sys.call("rm -f " .. fileRename(rv.db, "*") .. " && wrtbwmon -46 -f " .. rv.db .. " >>/dev/null 2>&1")
		luci.http.status(200, "OK")
		return
	end
-%>

<%+header%>

<style>
	.showMore.hide {
		display: none;
	}

	.tr.table-totals {
		background: #eee !important;
	}
</style>

<div class="cbi-map">
	<h2><%:Usage - Details%></h2>

	<div class="cbi-section">
		<div class="table">
			<div class="tr">
				<div class="td left" style="width:10%">
					<label><%:protocol:%></label>
				</div>
				<div class="td left" style="width:30%">
					<select id="Select46" style="width:auto">
						<option value="ipv4"  selected="selected" >ipv4</option>
						<option value="ipv6">ipv6</option>
					</select>
				</div>
				<div class="td left" style="width:10%">
					<label for="isShow" style="vertical-align:middle;"><%:Show Zeros:%></label>
				</div>
				<div class="td left" style="width:30%">
					<input id="isShow" type="checkbox" name="showing" style="vertical-align:middle;"/>
				</div>
				<div class="td right">
					<input id="resetDatabase" type="button" class="cbi-button" value="<%:Reset Database%>" >
				</div>
			</div>
			<div class="tr">
				<div class="td left" style="width:10%"><label><%:bandwidth:%></label></div>
				<div class="td left" style="width:30%">
					<input type="text" id="setBD" value="1M" />
					<label id="checkBD"></label>
				</div>
				<div class="td left" style="width:10%">
					<label for="showMore" style="vertical-align:middle;"><%:Show More:%></label>
				</div>
				<div class="td left" style="width:30%">
					<input id="showMore" type="checkbox" name="showing" style="vertical-align:middle;"/>
				</div>
				<div class="td"></div>
			</div>
		</div>
	</div>

	<div class="cbi-section">
		<div class="table">
			<div class="tr">
				<div class="td left" style="width:70%">
					<small><div id="updated" style="display:inline"></div><div id="updating" style="display:inline"></div></small>
				</div>
				<div class="td right" style="width:30%">
					<label for="intervalSelect"><%:Auto update every%></label>
					<select id="intervalSelect">
						<option value="-1"><%:Disabled%></option>
						<option value="1"><%:1 second%></option>
						<option value="2"  selected="selected"><%:2 seconds%></option>
						<option value="5"><%:5 seconds%></option>
						<option value="10"><%:10 seconds%></option>
						<option value="20"><%:20 seconds%></option>
						<option value="30"><%:30 seconds%></option>
						<option value="60"><%:60 seconds%></option>
						<option value="120"><%:2 minutes%></option>
					</select>
				</div>
			</div>
		</div>

		<div class="table">
			<div class="tr"><div class="td left" style="width:10%"><%:downflow:%></div><div class="td left" id="downflow">-</div></div>
			<div class="tr"><div class="td left" style="width:10%"><%:upflow:%></div><div class="td left" id="upflow">-</div></div>
		</div>

		<div class="table" id="targetTable">
			<div class="tr table-titles">
				<div class="th" id="thClient" style="width:17%"><%:Clients%></div>
				<div class="th showMore hide" id="thMAC" style="width:10%"><%:MAC%></div>
				<div class="th" id="thDownload" style="width:8%"><%:Download%></div>
				<div class="th" id="thUpload" style="width:8%"><%:Upload%></div>
				<div class="th" id="thTotalDown" style="width:9%"><%:Total Down%></div>
				<div class="th" id="thTotalUp" style="width:9%"><%:Total Up%></div>
				<div class="th" id="thTotal" style="width:9%"><%:Total%></div>
				<div class="th showMore hide" id="thFirstSeen" style="width:15%"><%:First Seen%></div>
				<div class="th showMore hide" id="thLastSeen" style="width:15%"><%:Last Seen%></div>
			</div>
			<div class="tr placeholder">
				<div class="td"><em><%:Collecting data...%></em></div>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">//<![CDATA[

(function () {
	var bandwidth = parseSize("1M"), isShowZero = 0, showMore = false;
	var interval = document.getElementById('intervalSelect').value;
	var sortedColumn = 6, sortDirection = "desc";
	var pairNum = {thClient: 9, thMAC: 1, thDownload: 2, thUpload: 3, thTotalDown: 4,
				thTotalUp: 5, thTotal: 6, thFirstSeen: 7, thLastSeen: 8,};
	var cachedData = [];

	function parseSize(size){
		var strTest = (/^[0-9]+\.?[0-9]*[\s]*[KMGTP]?B?(\/s)?$/g).test(size);
		if (!strTest) {
			return -1;
		}else{
			var num = (size).match(/^[0-9]+\.?[0-9]*/g);
			var base = (size).match(/[KMGTPEZ]/i);
			var unitBD = ["" , "K", "M", "G", "T", "P", "E", "Z"]
			for (var i = 0; i < unitBD.length; i++){
				if (base == unitBD[i]){
					base = 1024**i;
					break;
				}
				if (!base)
					base = 1;
			}
			return Math.round(parseFloat(num) * base);
		}
	}

	function dateToString(date) {
		var d = new Date((/\W/g).test(date) ? date : date * 1000);
		d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
		return d.toJSON().substr(0, 19).replace("T", " ")
//		return d.toLocaleString([], {hour12: false, year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit", second: "2-digit"})
//		var Y = d.getFullYear(), M = d.getMonth(), D = d.getDate();
//		var hh = d.getHours(), mm = d.getMinutes(), ss = d.getSeconds();
//		return "%04d/%02d/%02d %02d:%02d:%02d".format(Y, M, D, hh, mm, ss);
	}

	function isArray(obj) {
		return obj instanceof Array;
	}

	function handleError() {
		// TODO handle errors
		// var message = 'Something went wrong...';
	}

	function parseValues(values) {
		// check if data is array
		if (!isArray(values)) return [''];

		values.shift(); //Remove the first line.

		var valArr = [], totals = [0, 0, 0, 0, 0];
		var rowNum = values.length;
		for (var i = 0; i < rowNum ; i++) {
			if ( isShowZero || parseInt(values[i][5]) != 0 ) {
				var valRow = [].concat([values[i][2], values[i][0]], values[i].slice(3), [values[i][1]])
				valArr.push(valRow);
				for (var j = 0; j < totals.length; j++) {
					totals[j] += parseInt(valRow[2 + j]);
				}
			}
		}
		return [valArr, totals];
	}

	function displayTable(values) {
		values[0].sort(sortingFunction);
		var tb = document.getElementById('targetTable')

//		display data
//		console.time('update_table');
		updateTable(tb, values, '<em><%:Loading...%></em>');
//		console.timeEnd('update_table');

		document.getElementById('downflow').innerHTML = progressbar(values[1][0], bandwidth);
		document.getElementById('upflow').innerHTML = progressbar(values[1][1], bandwidth);
		return
	}

	function updateTable(tb, values, placeholder) {
		var dom = document.createDocumentFragment(), nodeLen = tb.childElementCount - 2;
		var tabData = values[0], shadowNode, newNode, childTD, tabTitle = tb.firstElementChild;
		// Create the shadow node, which will be used in the following.
		if (tabData.length > nodeLen) {
			if (tb.childElementCount > 2) {
				shadowNode = tabTitle.nextElementSibling.cloneNode(true);
			} else {
				shadowNode = document.createElement('div');
				childTD = document.createElement('div');
				childTD.appendChild(document.createTextNode(''));
				for (var j = 0; j < tabTitle.children.length; j++) {
					childTD.className = 'td' + (!showMore && '178'.indexOf(j) != -1 ? ' hide showMore' : '');
					childTD.setAttribute('data-title', tabTitle.children[j].innerHTML);
					shadowNode.appendChild(childTD.cloneNode(true));
				}
				shadowNode.firstElementChild.appendChild(document.createElement('br'));
				shadowNode.firstElementChild.appendChild(document.createTextNode(''));
			}
		}
		// Update the table data.
		for (var i = 0; i < tabData.length; i++) {
			if (i < nodeLen) {
				newNode = tabTitle.nextElementSibling;
			} else {
				newNode = shadowNode.cloneNode(true);
				newNode.className = 'tr cbi-rowstyle-%d'.format(i % 2 ? 2 : 1);
			}
			childTD = newNode.firstElementChild;
			childTD.title = tabData[i][1];
			childTD.lastChild.nodeValue = tabData[i].slice(-1);
			for (var j = 0; j < tabTitle.childElementCount; j++, childTD = childTD.nextElementSibling){
				childTD.firstChild.nodeValue = ('23456'.indexOf(j) != -1 ?
					'%1024.2mB' + ('23'.indexOf(j) != -1  ? '/s' : '') :
					'%s').format('78'.indexOf(j) != -1 ? dateToString(tabData[i][j]) : tabData[i][j]);
			}
			dom.appendChild(newNode);
		}
		// Remove the table data which has been deleted from the database.
		while (tb.childElementCount > 2) {
			tb.removeChild(tabTitle.nextElementSibling);
		}
		//Append the totals or placeholder row.
		dom.appendChild(tb.lastElementChild);
		newNode = dom.lastElementChild;
		if (newNode.classList.contains('table-totals')) {
			if (tabData.length == 0) {
				while (newNode.firstElementChild.firstChild.nextSibling) {
					newNode.removeChild(newNode.lastElementChild);
				};
				newNode.className = 'tr placeholder';
				newNode.firstChild.innerHTML = placeholder;
			}
		} else {
			if (tabData.length > 0) {
				dom.replaceChild(shadowNode.cloneNode(true), newNode);
				newNode = dom.lastElementChild;
				newNode.className = 'tr table-totals';
				while (newNode.firstElementChild.firstChild.nextSibling) {
					newNode.firstElementChild.removeChild(newNode.firstElementChild.lastChild);
				};
				newNode.firstElementChild.style.fontWeight = 'bold';
				newNode.firstElementChild.nextSibling.style.fontWeight = 'bold';
			}
		}

		if (newNode.classList.contains('table-totals')) {
			newNode.firstElementChild.firstChild.nodeValue = !showMore ? '<%:TOTAL%>: ' + tabData.length : '<%:TOTAL%>:';
			newNode.firstElementChild.nextSibling.firstChild.nodeValue = !showMore ? '' : tabData.length + ' <%:Clients%>';
			for (var j = 0; j < values[1].length; j++) {
				newNode.children[j + 2].firstChild.nodeValue = '%1024.2mB'.format(values[1][j]) + (j < 2 ? '/s' : '');
			}
		}
		tb.appendChild(dom);
	}

	function sortingFunction(x, y){
		var byCol, byDirection = sortDirection;
		if (x[sortedColumn] == y[sortedColumn]) {
			byCol = 1;
		} else {
			byCol = sortedColumn;
		}

		var n1 = x[byCol], n2 = y[byCol];
		var flag = byDirection =="desc" ? 1 : -1;
		var ipCk1 = 1, ipCk2 = 1, toHex = false;
		var a = n1.split(/[^\w\d]/g), b = n2.split(/[^\w\d]/g);

		if ( byCol == "9" ) {
			ipCk1 = cbi_validators.ipaddr.apply(n1) ? 1 : 0;
			ipCk2 = cbi_validators.ipaddr.apply(n2) ? 1 : 0;
			a = cbi_validators.ip6addr.apply(n1) ? (toHex = true, IPv6(n1)) : a;
			b = cbi_validators.ip6addr.apply(n2) ? (toHex = true, IPv6(n2)) : b;
		}

		if (ipCk1 * ipCk2 == 0) {
			return (ipCk2 - ipCk1) * flag;
		}

		var len = (a.length <= b.length ? a.length : b.length);

		for (var i = 0 ; i < len ; i++ ) {
			if (byCol == "1" || (byCol == "9" && toHex)) {
				num1 = parseInt(a[i], 16);
				num2 = parseInt(b[i], 16);
			} else if (a[i].match(/[a-z]/ig) || b[i].match(/[a-z]/ig)){
				num1 = a[i].toLowerCase();
				num2 = b[i].toLowerCase();
			} else {
				num1 = parseInt(a[i]);
				num2 = parseInt(b[i]);
			}

			if (num1 != num2) return ((num2 - num1) * flag);
		}
		return flag ;
	}

	function progressbar(v, m){
		var vn = parseInt(v) || 0;
		var mn = parseInt(m) || 100;
		var pc = ((100 / mn) * vn).toFixed(2);
		var wt = Math.floor(pc > 100 ? 100 : pc);

		if (pc >= 95){
			var bkc = "rgb(248, 0, 16)";
		}else if(pc >= 80 && pc < 95){
			var bkc = "rgb(255, 0, 255)";
		}else if(pc >= 60 && pc < 80){
			var bkc = "rgb(255, 255, 0)";
		}else{
			var bkc = "rgb(100, 255, 100)";
		}

		return String.format(
			'<div style="width:100%%; position:relative; border:1px solid #999999">' +
				'<div style="background-color: %s; width:%d%%; height:15px">' +
					'<div style="position:absolute; left:0; top:0; text-align:center; width:100%%; color:#000000">' +
						'<small>%1024.2mB/s (%f%%)</small>' +
					'</div>' +
				'</div>' +
			'</div>', bkc, wt, vn, pc
		);
	}

	function registerTableEventHandlers() {
		document.getElementById('xhr_poll_status').onclick= function() {
			var e = document.getElementById('intervalSelect');
			XHR.running() ? (XHR.halt(), e.value=-1) : (XHR.run(), e.value=interval);
		}

		document.getElementById('targetTable').querySelectorAll('.th').forEach( function(e) {
			if (e) {
				e.addEventListener('click', function () {
					setSortColumn(this.id);
				});
			}
		});

		document.getElementById('intervalSelect').addEventListener('change', function () {
			interval = this.value;
			if (interval > 0) {
				// it is not scheduled, schedule it
				if (!XHR.running()) {
					XHR.run();
				}
				XHR._q[0].interval = interval;
			} else {
				// stop the scheduling
				XHR.halt();
				setUpdateMessage('');
			}
		});

		document.getElementById('resetDatabase').addEventListener('click', function () {
			if (confirm('<%:This will delete the database file. Are you sure?%>')) {
				new XHR().post('<%=REQUEST_URI%>',{reset: 1},
				function(xhr) {
					document.location.reload();
				})
			}
		});

		document.getElementById('setBD').addEventListener('input', function () {
			var tb = document.getElementById("checkBD");
			var strTest = (/^[0-9]+\.?[0-9]*[\s]*[KMGTP]?B?(\/s)?$/g).test(this.value);

			if (strTest) {
				tb.innerHTML = '&#10004';
			}
			else{
				tb.innerHTML = '&#10006';
			}
		});

		document.getElementById('setBD').addEventListener('blur', function () {
			var tb = document.getElementById("checkBD");
			bandwidth = parseSize(this.value);

			if (bandwidth == -1) {
				alert('Error! Bandwidth reset!!!');
				this.value = '1M';
				bandwidth = 1048576;
			}
			tb.innerHTML= "";
		});

		document.getElementById('Select46').addEventListener('change', function () {
			var selection = this.value;

			XHR._q[0].data={
				proto: selection,
				interval: interval
			};
		});

		document.getElementById('isShow').addEventListener('click', function () {
			if ( this.checked == true ){
				isShowZero = 1
			}else{
				isShowZero = 0
			}
		});

		document.getElementById('showMore').addEventListener('click', function () {
			var target = document.querySelector('.tr.table-totals').firstElementChild;
			target.firstChild.nodeValue = showMore ? '<%:TOTAL%>: ' + cachedData[0].length : '<%:TOTAL%>:';
			target.nextElementSibling.firstChild.nodeValue = showMore ? '' : cachedData[0].length + ' <%:Clients%>';
			if ( this.checked == true ){
				showMore = true;
				document.querySelectorAll('.showMore').forEach(function(e){
					if(e) e.classList.remove('hide');
				});
			}else{
				showMore = false;
				sortedColumn = "178".indexOf(sortedColumn) !=-1 ? (setSortColumn(Object.keys(pairNum)[6]), 6) : sortedColumn;
				document.querySelectorAll('.showMore').forEach(function(e){
					if(e) e.classList.add('hide');
				});
			}
		});
	}

	function updateData() {
		var status = {
			proto: document.getElementById('Select46').value,
			interval: interval
		}

		XHR.poll(interval, '<%=REQUEST_URI%>', status,
		function(x, info)
		{
//			console.time('start');
			status.interval = interval;
			if (!info) {
				handleError();
			} else {
				cachedData = parseValues(info);
				setSortColumn(null);
				document.getElementById('updated').innerHTML = '<%:Last updated %>' + dateToString(Date.now() / 1000) +'<%:.%> ';
			}
//			console.timeEnd('start');
		});
		updatePerSec();
	}

	function updatePerSec(){
		XHR.poll(1, '<%=REQUEST_URI%>', {UpdateLable: 1},
		function(x, data)
		{
			var intervalMain = XHR._q[0].interval
			var sec = (intervalMain - (XHR._t - 1) % intervalMain) % intervalMain;
			setUpdateMessage('<%:Updating again in%> <b>' + sec + '</b> <%:seconds.%>');
			if(sec == 0){
				setTimeout(function(){
					setUpdateMessage('<%:Updating again in%> <b>' + interval + '</b> <%:seconds.%>');
				}, 50);
			}
		});
	}

	function setUpdateMessage(msg) {
		document.getElementById('updating').innerHTML = msg;
	}

	function setSortColumn(eltid) {
		// Remove the old sorted sign.
		var sortedColumnIndex = Object.values(pairNum).indexOf(sortedColumn);
		var e = document.getElementById(Object.keys(pairNum)[sortedColumnIndex]);
		if (e){
			e.innerHTML = e.innerHTML.replace(/\u25B2|\u25BC/, "");
		}

		// Toggle the sort direction.
		if (eltid != null ) {
			if ( pairNum[eltid] == sortedColumn ) {
				if (sortDirection == "desc")
					sortDirection = "asc";
				else
					sortDirection = "desc";
			}
			else {
				sortDirection = "desc";
			}
		}

		// Get the new coloum to sort.
		sortedColumn = eltid != null ? pairNum[eltid] : sortedColumn;
		// Display the sorted values.
		displayTable(cachedData);

		// Set the new sign for the sorting coloum.
		var sortedColumnIndex = Object.values(pairNum).indexOf(sortedColumn);
		var e = document.getElementById(Object.keys(pairNum)[sortedColumnIndex]);
		if (e){
			e.innerHTML += (sortDirection == "asc" ? "\u25B2" : "\u25BC");
		}
	}

	if (<%=luci.http.write_json(luci.sys.exec("opkg status wrtbwmon") == "")%>) {
		alert("<%:wrtbwmon is not installed!%>");
		return 0;
	}

	registerTableEventHandlers();
	updateData();
	return 0;
})();
//]]></script>

<%+footer%>
